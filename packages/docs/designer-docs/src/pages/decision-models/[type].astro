---
import { getCollection, render } from 'astro:content';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { Badge, LinkCard } from '@astrojs/starlight/components';
import type { DecisionModelMeta } from '@noodlestan/designer-decisions';
import { ShowDecisionCard } from '@noodlestan/designer-shows/astro';

import { sidebar } from '../../navigation/sidebar';
import { decisionLoader } from '../../decisions';

export const store = await decisionLoader();

export async function getStaticPaths() {
    const decisionTypes = await getCollection('decisionTypes');
    return decisionTypes.map(decisionType => ({
        params: { type: decisionType.data.type },
        props: { decisionType },
    }));
}

const { decisionType } = Astro.props;
const { Content } = await render(decisionType);

const decisions = store.records();
const samples = decisions.filter(d => d.model.startsWith(decisionType.id));


const headings = [
    {
        depth: 2,
        slug: 'models',
        text: 'Decision models'
    }
]
if (samples.length) {
    headings.unshift({
        depth: 2,
        slug: 'samples',
        text: 'Samples'
    })
}

const frontmatter = {
    ...decisionType.data,
    title: decisionType.data.name,
    headings
};
---

<StarlightPage frontmatter={frontmatter} sidebar={sidebar}>
    <p>
        <Badge variant="tip" text={decisionType.data.domain} />
        <Badge variant="note" text={decisionType.data.category} />
    </p>

    <blockquote>
        <p>type: <code>{decisionType.data.type}</code></p>
        {decisionType.data.description}
    </blockquote>

    <h3 id="models">Models</h3>
    <ul>
    {
        decisionType.data.models.map((m: DecisionModelMeta) => (
            <li>
                <a href={`/decision-models/${m.model}`}>{m.name}</a>
                {m.description}
            </li>
        ))
    }
    </ul>

    {(samples.length) ?
        <>
            <h3 id="samples">Samples</h3>
            <ul>
            {
                samples.map(decision => (
                    <li class="dd-sample">
                        <ShowDecisionCard store={store} d={decision.name} model params />
                    </li>
                ))
            }
            </ul>
        </>
        : <></>
    }

    <Content />

    <LinkCard href="/decision-models" title="Other decision types" />
</StarlightPage>

<style>
    .dd-item {

    }
</style>
