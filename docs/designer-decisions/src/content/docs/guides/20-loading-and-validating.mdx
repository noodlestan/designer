---
title: Loading and Validating Decisions
slug: guides/loading-and-validating-design-decisions
description: How to validate design decisions with JSON schemas and validators
sidebar:
    order: 20
    label: Loading and Validating
---

import { CardGrid, FileTree, LinkCard } from '@astrojs/starlight/components';

import { GetInvolved } from '../../../components/atoms';
import { href } from '../../../mdx';

This guide explains how to load and validate decision records from a simple script.

## Setup

### Dependencies

The following packages are required:

-   [@noodlestan/designer-functions](/api/designer-functions)
-   [@noodlestan/designer-schemas](/api/designer-schemas)

```bash
npm install @noodlestan/designer-functions @noodlestan/designer-schemas
```

### Decision data

Populate your design decisions data source.

As illustrated in the [Capturing Design Decisions](/guides/capturing-design-decisions-in-data) guide, you can simply create one or more JSON files anywhere in your project.

<FileTree>

-   data/
    -   decisions/
        -   color.json
        -   space.json
        -   ...

</FileTree>

## Loading input data

Add a script to load decisions and print eventual validation errors.

<FileTree>
-   data/
-   scripts
    - **validate-decisions.js**

</FileTree>

We will use the _all-in-one_ [createDecisionLoader()](/api/designer-functions/Loader/createDecisionLoader), providing it with:

-   The [schema definition](/models/schemas) for the built-in decision models.
-   A directory to load decision data from.
-   A function to resolve the physical location of the `node_module` containing the schemas.

```js "createDecisionLoader"
// scripts/validate-decisions.js
import path from 'path';
import { createDecisionLoader } from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);
```

<GetInvolved url="https://github.com/noodlestan/designer/issues/80">
    How to provide a package resolution default?
</GetInvolved>

This loader returns a [pre-validated decision store](/api/designer-functions/Types/StaticDecisionStore) asynchronously.

The store exposes all input records along with any errors that may have occurred while loading data and schemas or when validating input data.

## Validating input data

We can format the errors using the `formatValidationError()` utility function and print all the validation errors so that we can inspect them.

```js collapse={4-13,27-28} "formatValidationError"
// scripts/validate-decisions.js
import path from 'path';
import { createDecisionLoader, formatValidationError } from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);

const loadDecisions = async () => {
    const store = await loader();
    if (store.hasErrors()) {
        store.storeErrors().forEach(({ msg, error }) => console.error(msg, error));
        store.validationErrors().forEach(error => console.error(formatValidationError(error)));
        throw new Error(`Validation errors.`);
    }

    const records = store.records();
    records.forEach(record => console.info(record.name));
    console.info(`ðŸ˜ ${records.length} records`);
};

loadDecisions();
```

You can run this directly from the command line:

```bash
node scripts/validate-decisions.js
```

If no errors occur, the output should look something like:

```
...
Avatar Minimum Size
Avatar Sizes
ðŸ˜ 4 records
```

In case of validation errors these will be printed at the top.

For instance, if we delete the `param` attribute from a couple of decision input records, the output should show something like:

```
ðŸŸ¨ Decision Pink Palette (required) must have required property 'params'
ðŸŸ¨ Brand Pink Hue (required) must have required property 'params'
Error: Validation errors.
```

## Inspecting and validating decision values

So far, the script only validates the input data against the schemas, guaranteeing that all the required attributes are present and that they are of the correct type.

Producing decision values may still result in errors if, for instance, a reference to another decision can not be resolved, or it resolves to a decision of the wrong type.

The following 2 utility functions help with this:

-   [produceDecisions()](/api/designer-functions/cli-helpers/produceDecisions): aggregates all produced values, contexts, and errors.
-   [formatDecisionStatus()](/api/designer-functions/cli-helpers/formatDecisionStatus): returns a formatted decision, including its value and errors details.

Add these 2 lines to the script:

```diff lang="js" collapse={9-21,31-34} "formatDecisionStatus" "produceDecisions"
// scripts/validate-decisions.js
import path from 'path';
import {
    createDecisionLoader,
    formatValidationError,
    formatDecisionStatus,
    produceDecisions
} from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);

const loadDecisions = async () => {
    const store = await loader();
    if (store.hasErrors()) {
        store.storeErrors().forEach(({ msg, error }) => console.error(msg, error));
-       store.validationErrors().forEach(error => console.error(formatValidationError(error)));
        throw new Error(`Validation errors.`);
    }

+   const produced = produceDecisions(store);
+   produced.decisions().forEach(status => console.info(formatDecisionStatus(status)));

    console.info(`ðŸ˜ ${records.length} records`);
};

loadDecisions();
```

The output will look something like this.

```
ðŸŸ© | Layout Scale | space-scale/anchored | [8px, 16px, 32px, 64px, 128px, 256px] |
```

The following example output was the result of changing the `Sizing Scale` decision, introducing two issues:

-   the `Size Smallest` decision does not exist;
-   the `Brand Black` decision is a color decision but the model expected the reference to match a [Space Value](/models/decision-types/space-value) or a [Space Scale](/models/decision-types/space-scale)
    decision.

```
ðŸŸ¨ | Sizing Scale | space-scale/bounded | [0px, 0px, 0px, 0px, 0px, 0px] | 2 warnings

 > ðŸŸ¨ Ref (SpaceValue) {"$name":"Size Smallest"} not found.
 > ðŸŸ¨ Ref (SpaceValue) {"$name":"Brand Black"} matched "color-value".
```

## Filtering

If you wish to filter out decisions that produce valid values, and inspect only the errors, you can adjust your script to the following:

```js collapse={2-27,33-36} "filter" "hasErrors"
// scripts/validate-decisions.js
import path from 'path';
import {
    createDecisionLoader,
    formatValidationError,
    formatDecisionStatus,
    produceDecisions
} from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);

const loadDecisions = async () => {
    const store = await loader();
    if (store.hasErrors()) {
        store.storeErrors().forEach(({ msg, error }) => console.error(msg, error));
        throw new Error(`Validation errors.`);
    }

    const produced = produceDecisions(store);
    produced
        .decisions()
        .filter(status => status.hasErrors)
        .forEach(status => console.info(formatDecisionStatus(status)));

    console.info(`ðŸ˜ ${records.length} records`);
};

loadDecisions();
```

## Summarizing and catching errors

The `produced` object reports counts for decision records, and different types of errors in a single string.

```js collapse={2-28,32-34} "filter" "hasErrors"
// scripts/validate-decisions.js
import path from 'path';
import {
    createDecisionLoader,
    formatValidationError,
    formatDecisionStatus,
    produceDecisions
} from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);

const loadDecisions = async () => {
    const store = await loader();
    if (store.hasErrors()) {
        store.storeErrors().forEach(({ msg, error }) => console.error(msg, error));
        throw new Error(`Validation errors.`);
    }

    const produced = produceDecisions(store);
    produced.decisions().forEach(status => console.info(formatDecisionStatus(status)));

    console.info('ðŸ˜', produced.summary());
};

loadDecisions();
```

You can use it to summarize all counts in one line.

```
ðŸŸ¨ Decision "Sizing Space Scale" /params/after (required) must have required property 'steps'
ðŸ˜ 59 records, 0 errors, 1 warnings
```

If you are running this as part of your build process you will probably want to exit the script with an error code.

```js collapse={1-29} "throw" "catch" "exit(1)"
// scripts/validate-decisions.js
import path from 'path';
import {
    createDecisionLoader,
    formatValidationError,
    formatDecisionStatus,
    produceDecisions
} from '@noodlestan/designer-functions';
import { DECISION_SCHEMAS } from '@noodlestan/designer-schemas';

const DATA_PATH = path.resolve('./data/decisions');

const loader = createDecisionLoader(
    [DECISION_SCHEMAS],
    [DATA_PATH],
    // NOTE: you might need to adjust the path according to your repository setup
    async (moduleName: string) => `./node_modules/${moduleName}`
);

const loadDecisions = async () => {
    const store = await loader();
    if (store.hasErrors()) {
        store.storeErrors().forEach(({ msg, error }) => console.error(msg, error));
        throw new Error(`Validation errors.`);
    }

    const produced = produceDecisions(store);
    produced.decisions().forEach(status => console.info(formatDecisionStatus(status)));
    console.info('ðŸ˜', produced.summary());

    if (produced.hasErrors()) {
        throw new Error(`Errors encountered producing decisions.`);
    }
};

loadDecisions().catch(err => {
    console.error(err);
    process.exit(1);
});
```

## Next steps

The next guides provide step by step instructions on practical uses cases for your decision data:

<CardGrid>
    <LinkCard
        href={href('/guides/generating-css-variables-from-design-decisions-and-tokens')}
        title="Generating CSS Variables"
    />
    <LinkCard
        href={href('/guides/generating-documentation/using-astro-components-in-mdx')}
        title="Rendering in Astro/MDX"
    />

</CardGrid>

## See Also

-   [Decision Models Reference](/models/decision-types)
-   [Schemas Reference](/models/schemas)
-   [produceDecisions()](/api/designer-functions/cli-helpers/produceDecisions)
-   [formatDecisionStatus()](/api/designer-functions/cli-helpers/formatDecisionStatus)
